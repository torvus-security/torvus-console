"use strict";(()=>{var e={};e.id=204,e.ids=[204],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},4577:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},9643:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>q,requestAsyncStorage:()=>_,routeModule:()=>m,serverHooks:()=>v,staticGenerationAsyncStorage:()=>h});var s={};t.r(s),t.d(s,{POST:()=>f});var o=t(4345),a=t(4749),n=t(3914),i=t(1041),l=t(3680),u=t(1682),p=t(3199),d=t(9584);let c=l.Ry({id:l.Z_().uuid()});async function f(e){let r=await e.json().catch(()=>null),t=c.safeParse(r);if(!t.success)return i.NextResponse.json({error:"Invalid request id"},{status:400});let s=await (0,p.vT)(),o=(0,u.i_)(),{data:a,error:n}=await o.from("staff_dual_control_requests").select("*").eq("id",t.data.id).maybeSingle();if(n)return console.error("Failed to load dual-control request",n),i.NextResponse.json({error:"Unable to load request"},{status:500});if(!a)return i.NextResponse.json({error:"Request not found"},{status:404});if(a.requested_by===s.id)return i.NextResponse.json({error:"Dual-control approval requires a different approver."},{status:403});if("requested"!==a.status)return i.NextResponse.json({error:`Cannot approve request in status ${a.status}`},{status:409});let{data:l,error:f}=await o.from("staff_dual_control_requests").update({approved_by:s.id,status:"approved",approved_at:new Date().toISOString()}).eq("id",t.data.id).select().maybeSingle();return f?(console.error("Failed to approve dual-control request",f),i.NextResponse.json({error:"Unable to approve request"},{status:500})):((0,d.C4)().capture("dual_control_approved",{user:s.analyticsId,action:a.action_key,correlation_id:a.correlation_id,env:"production"}),i.NextResponse.json({request:l}))}let m=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/staff/dual-control/approve/route",pathname:"/api/staff/dual-control/approve",filename:"route",bundlePath:"app/api/staff/dual-control/approve/route"},resolvedPagePath:"/Users/haydenfarquhar/Projects/torvus-console/apps/console/app/api/staff/dual-control/approve/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:h,serverHooks:v}=m;function q(){return(0,n.patchFetch)({staticGenerationAsyncStorage:h,requestAsyncStorage:_})}},9584:(e,r,t)=>{t.d(r,{Se:()=>l,mL:()=>u,C4:()=>i});let s=require("node:crypto"),o=[{href:"/overview",label:"Overview",permission:"metrics.view"},{href:"/audit-events",label:"Audit Events",permission:"audit.read"},{href:"/releases",label:"Releases",permission:"releases.simulate"}];class a{capture(e,r={}){let t={event:e,properties:{$lib:"torvus-console",env:"production",...r},uuid:(0,s.randomUUID)()};this.queue.push({event:e,payload:t.properties}),this.host&&this.key&&fetch(`${this.host}/capture/`,{method:"POST",headers:{Authorization:`Bearer ${this.key}`,"Content-Type":"application/json"},body:JSON.stringify(t)}).catch(e=>{console.warn("Analytics capture failed",e)})}getQueue(){return[...this.queue]}constructor(){this.queue=[],this.host=process.env.NEXT_PUBLIC_POSTHOG_HOST,this.key=process.env.NEXT_PUBLIC_POSTHOG_KEY}}let n=null;function i(){return n||(n=new a),n}function l(e){let r=(0,s.createHash)("sha256");return r.update(e.trim().toLowerCase()),r.digest("hex")}function u(e){return o.filter(r=>!r.permission||e.includes(r.permission)).map(({href:e,label:r})=>({href:e,label:r}))}},3199:(e,r,t)=>{t.d(r,{Ot:()=>l,vT:()=>u});var s=t(3613),o=t(1682),a=t(9584);class n extends Error{constructor(e,r=403){super(e),this.status=r,this.name="StaffAccessError"}}let i=(0,s.cache)(async()=>{let e=(0,o.jq)(),{data:r,error:t}=await e.auth.getUser();return t?(console.error("Failed to resolve session user",t),null):r.user?{id:r.user.id,email:r.user.email??"unknown@torvussecurity.com"}:null}),l=(0,s.cache)(async()=>{let e=await i();if(!e)return null;let r=(0,o.i_)(),{data:t,error:s}=await r.from("staff_users").select("user_id, email, display_name, passkey_enrolled").eq("user_id",e.id).maybeSingle();if(s)throw console.error("Error loading staff user",s),new n("Unable to load staff profile",503);if(!t)return null;let{data:l,error:u}=await r.from("staff_role_members").select("role_id").eq("user_id",e.id);if(u)throw console.error("Error loading staff roles",u),new n("Unable to load staff roles",503);let p=l?.map(e=>e.role_id)??[],d=[],c=new Set;if(p.length){let{data:e,error:t}=await r.from("staff_roles").select("id, name").in("id",p);if(t)throw console.error("Error loading staff role names",t),new n("Unable to resolve role names",503);d=e?.map(e=>e.name)??[];let{data:s,error:o}=await r.from("staff_role_permissions").select("permission_key, role_id").in("role_id",p);if(o)throw console.error("Error loading staff permissions",o),new n("Unable to load staff permissions",503);s?.forEach(e=>{c.add(e.permission_key)})}return{id:t.user_id,email:t.email,displayName:t.display_name,passkeyEnrolled:t.passkey_enrolled,roles:d,permissions:Array.from(c),analyticsId:(0,a.Se)(t.email)}});async function u(e){let r=await l();if(!r)throw new n("Staff membership required",403);if(e?.permission&&!r.permissions.includes(e.permission))throw new n(`Missing required permission: ${e.permission}`,403);return r}},1682:(e,r,t)=>{t.d(r,{i_:()=>p,jq:()=>l});var s=t(5665),o=t(6663),a=t(7416);let n=["SUPABASE_URL","SUPABASE_ANON_KEY","SUPABASE_SERVICE_ROLE"];function i(){for(let e of n)if(!process.env[e])throw Error(`Missing required environment variable ${e}`)}function l(){return i(),(0,o.createServerComponentClient)({cookies:a.cookies},{supabaseUrl:process.env.SUPABASE_URL,supabaseKey:process.env.SUPABASE_ANON_KEY})}let u=null;function p(){return i(),u||(u=(0,s.eI)(process.env.SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE,{auth:{autoRefreshToken:!1,persistSession:!1}})),u}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[925,13,680,711],()=>t(9643));module.exports=s})();