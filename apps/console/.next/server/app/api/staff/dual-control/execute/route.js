"use strict";(()=>{var e={};e.id=617,e.ids=[617],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},4577:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},2577:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>q,requestAsyncStorage:()=>h,routeModule:()=>x,serverHooks:()=>v,staticGenerationAsyncStorage:()=>y});var s={};t.r(s),t.d(s,{POST:()=>_});var o=t(4345),n=t(4749),a=t(3914),i=t(1041),u=t(3680),l=t(1682),c=t(3199),d=t(9584);let p=u.Ry({id:u.Z_().uuid()}),f={"releases.execute":"releases.execute","policy.edit":"policy.edit"};async function m(e,r){console.info("[dual-control] executing action",e,r)}async function _(e){if("1"!==process.env.TORVUS_FEATURE_ENABLE_RELEASE_EXECUTION)return i.NextResponse.json({error:"Release execution disabled by feature flag."},{status:403});let r=await e.json().catch(()=>null),t=p.safeParse(r);if(!t.success)return i.NextResponse.json({error:"Invalid request id"},{status:400});let s=await (0,c.vT)(),o=(0,l.i_)(),{data:n,error:a}=await o.from("staff_dual_control_requests").select("*").eq("id",t.data.id).maybeSingle();if(a)return console.error("Failed to fetch dual-control request",a),i.NextResponse.json({error:"Unable to load request"},{status:500});if(!n)return i.NextResponse.json({error:"Request not found"},{status:404});if("executed"===n.status)return i.NextResponse.json({request:n});if("approved"!==n.status)return i.NextResponse.json({error:`Cannot execute request in status ${n.status}`},{status:409});if(!n.approved_by)return i.NextResponse.json({error:"Request must be approved before execution."},{status:409});if(n.approved_by===s.id)return i.NextResponse.json({error:"Executor must differ from approver."},{status:403});let u=f[n.action_key]??"releases.execute";if(!s.permissions.includes(u))return i.NextResponse.json({error:"Permission denied for execution."},{status:403});await m(n.action_key,n.payload??{});let{data:_,error:x}=await o.from("staff_dual_control_requests").update({status:"executed",executed_at:new Date().toISOString()}).eq("id",t.data.id).select().maybeSingle();return x?(console.error("Failed to mark execution",x),i.NextResponse.json({error:"Unable to execute request"},{status:500})):((0,d.C4)().capture("dual_control_executed",{user:s.analyticsId,action:n.action_key,correlation_id:n.correlation_id,env:"production"}),i.NextResponse.json({request:_}))}let x=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/staff/dual-control/execute/route",pathname:"/api/staff/dual-control/execute",filename:"route",bundlePath:"app/api/staff/dual-control/execute/route"},resolvedPagePath:"/Users/haydenfarquhar/Projects/torvus-console/apps/console/app/api/staff/dual-control/execute/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:y,serverHooks:v}=x;function q(){return(0,a.patchFetch)({staticGenerationAsyncStorage:y,requestAsyncStorage:h})}},9584:(e,r,t)=>{t.d(r,{Se:()=>u,mL:()=>l,C4:()=>i});let s=require("node:crypto"),o=[{href:"/overview",label:"Overview",permission:"metrics.view"},{href:"/audit-events",label:"Audit Events",permission:"audit.read"},{href:"/releases",label:"Releases",permission:"releases.simulate"}];class n{capture(e,r={}){let t={event:e,properties:{$lib:"torvus-console",env:"production",...r},uuid:(0,s.randomUUID)()};this.queue.push({event:e,payload:t.properties}),this.host&&this.key&&fetch(`${this.host}/capture/`,{method:"POST",headers:{Authorization:`Bearer ${this.key}`,"Content-Type":"application/json"},body:JSON.stringify(t)}).catch(e=>{console.warn("Analytics capture failed",e)})}getQueue(){return[...this.queue]}constructor(){this.queue=[],this.host=process.env.NEXT_PUBLIC_POSTHOG_HOST,this.key=process.env.NEXT_PUBLIC_POSTHOG_KEY}}let a=null;function i(){return a||(a=new n),a}function u(e){let r=(0,s.createHash)("sha256");return r.update(e.trim().toLowerCase()),r.digest("hex")}function l(e){return o.filter(r=>!r.permission||e.includes(r.permission)).map(({href:e,label:r})=>({href:e,label:r}))}},3199:(e,r,t)=>{t.d(r,{Ot:()=>u,vT:()=>l});var s=t(3613),o=t(1682),n=t(9584);class a extends Error{constructor(e,r=403){super(e),this.status=r,this.name="StaffAccessError"}}let i=(0,s.cache)(async()=>{let e=(0,o.jq)(),{data:r,error:t}=await e.auth.getUser();return t?(console.error("Failed to resolve session user",t),null):r.user?{id:r.user.id,email:r.user.email??"unknown@torvussecurity.com"}:null}),u=(0,s.cache)(async()=>{let e=await i();if(!e)return null;let r=(0,o.i_)(),{data:t,error:s}=await r.from("staff_users").select("user_id, email, display_name, passkey_enrolled").eq("user_id",e.id).maybeSingle();if(s)throw console.error("Error loading staff user",s),new a("Unable to load staff profile",503);if(!t)return null;let{data:u,error:l}=await r.from("staff_role_members").select("role_id").eq("user_id",e.id);if(l)throw console.error("Error loading staff roles",l),new a("Unable to load staff roles",503);let c=u?.map(e=>e.role_id)??[],d=[],p=new Set;if(c.length){let{data:e,error:t}=await r.from("staff_roles").select("id, name").in("id",c);if(t)throw console.error("Error loading staff role names",t),new a("Unable to resolve role names",503);d=e?.map(e=>e.name)??[];let{data:s,error:o}=await r.from("staff_role_permissions").select("permission_key, role_id").in("role_id",c);if(o)throw console.error("Error loading staff permissions",o),new a("Unable to load staff permissions",503);s?.forEach(e=>{p.add(e.permission_key)})}return{id:t.user_id,email:t.email,displayName:t.display_name,passkeyEnrolled:t.passkey_enrolled,roles:d,permissions:Array.from(p),analyticsId:(0,n.Se)(t.email)}});async function l(e){let r=await u();if(!r)throw new a("Staff membership required",403);if(e?.permission&&!r.permissions.includes(e.permission))throw new a(`Missing required permission: ${e.permission}`,403);return r}},1682:(e,r,t)=>{t.d(r,{i_:()=>c,jq:()=>u});var s=t(5665),o=t(6663),n=t(7416);let a=["SUPABASE_URL","SUPABASE_ANON_KEY","SUPABASE_SERVICE_ROLE"];function i(){for(let e of a)if(!process.env[e])throw Error(`Missing required environment variable ${e}`)}function u(){return i(),(0,o.createServerComponentClient)({cookies:n.cookies},{supabaseUrl:process.env.SUPABASE_URL,supabaseKey:process.env.SUPABASE_ANON_KEY})}let l=null;function c(){return i(),l||(l=(0,s.eI)(process.env.SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE,{auth:{autoRefreshToken:!1,persistSession:!1}})),l}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[925,13,680,711],()=>t(2577));module.exports=s})();