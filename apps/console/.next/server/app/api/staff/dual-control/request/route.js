"use strict";(()=>{var e={};e.id=290,e.ids=[290],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},4577:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},8089:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>v,requestAsyncStorage:()=>h,routeModule:()=>_,serverHooks:()=>q,staticGenerationAsyncStorage:()=>y});var s={};t.r(s),t.d(s,{POST:()=>m});var o=t(4345),a=t(4749),i=t(3914),n=t(1041),l=t(3680),u=t(1682),c=t(3199),d=t(9584);let p=l.Ry({actionKey:l.Z_().min(3).max(128),payload:l.IM(l.Yj()).default({}),correlationId:l.Z_().min(8).max(128)}),f={"releases.execute":"releases.execute","policy.edit":"policy.edit","staff.manage":"staff.manage"};async function m(e){let r=await e.json().catch(()=>null),t=p.safeParse(r);if(!t.success)return n.NextResponse.json({error:"Invalid request payload"},{status:400});let s=await (0,c.vT)(),o=f[t.data.actionKey]??"policy.edit";if(!s.permissions.includes(o))return n.NextResponse.json({error:"Permission denied for requested action."},{status:403});let a=(0,u.i_)(),{data:i,error:l}=await a.from("staff_dual_control_requests").upsert({action_key:t.data.actionKey,payload:t.data.payload,correlation_id:t.data.correlationId,requested_by:s.id,status:"requested"},{onConflict:"action_key,correlation_id"}).select().maybeSingle();return l?(console.error("Failed to create dual-control request",l),n.NextResponse.json({error:"Unable to create request"},{status:500})):((0,d.C4)().capture("dual_control_requested",{user:s.analyticsId,action:t.data.actionKey,correlation_id:t.data.correlationId,env:"production"}),n.NextResponse.json({request:i}))}let _=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/staff/dual-control/request/route",pathname:"/api/staff/dual-control/request",filename:"route",bundlePath:"app/api/staff/dual-control/request/route"},resolvedPagePath:"/Users/haydenfarquhar/Projects/torvus-console/apps/console/app/api/staff/dual-control/request/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:y,serverHooks:q}=_;function v(){return(0,i.patchFetch)({staticGenerationAsyncStorage:y,requestAsyncStorage:h})}},9584:(e,r,t)=>{t.d(r,{Se:()=>l,mL:()=>u,C4:()=>n});let s=require("node:crypto"),o=[{href:"/overview",label:"Overview",permission:"metrics.view"},{href:"/audit-events",label:"Audit Events",permission:"audit.read"},{href:"/releases",label:"Releases",permission:"releases.simulate"}];class a{capture(e,r={}){let t={event:e,properties:{$lib:"torvus-console",env:"production",...r},uuid:(0,s.randomUUID)()};this.queue.push({event:e,payload:t.properties}),this.host&&this.key&&fetch(`${this.host}/capture/`,{method:"POST",headers:{Authorization:`Bearer ${this.key}`,"Content-Type":"application/json"},body:JSON.stringify(t)}).catch(e=>{console.warn("Analytics capture failed",e)})}getQueue(){return[...this.queue]}constructor(){this.queue=[],this.host=process.env.NEXT_PUBLIC_POSTHOG_HOST,this.key=process.env.NEXT_PUBLIC_POSTHOG_KEY}}let i=null;function n(){return i||(i=new a),i}function l(e){let r=(0,s.createHash)("sha256");return r.update(e.trim().toLowerCase()),r.digest("hex")}function u(e){return o.filter(r=>!r.permission||e.includes(r.permission)).map(({href:e,label:r})=>({href:e,label:r}))}},3199:(e,r,t)=>{t.d(r,{Ot:()=>l,vT:()=>u});var s=t(3613),o=t(1682),a=t(9584);class i extends Error{constructor(e,r=403){super(e),this.status=r,this.name="StaffAccessError"}}let n=(0,s.cache)(async()=>{let e=(0,o.jq)(),{data:r,error:t}=await e.auth.getUser();return t?(console.error("Failed to resolve session user",t),null):r.user?{id:r.user.id,email:r.user.email??"unknown@torvussecurity.com"}:null}),l=(0,s.cache)(async()=>{let e=await n();if(!e)return null;let r=(0,o.i_)(),{data:t,error:s}=await r.from("staff_users").select("user_id, email, display_name, passkey_enrolled").eq("user_id",e.id).maybeSingle();if(s)throw console.error("Error loading staff user",s),new i("Unable to load staff profile",503);if(!t)return null;let{data:l,error:u}=await r.from("staff_role_members").select("role_id").eq("user_id",e.id);if(u)throw console.error("Error loading staff roles",u),new i("Unable to load staff roles",503);let c=l?.map(e=>e.role_id)??[],d=[],p=new Set;if(c.length){let{data:e,error:t}=await r.from("staff_roles").select("id, name").in("id",c);if(t)throw console.error("Error loading staff role names",t),new i("Unable to resolve role names",503);d=e?.map(e=>e.name)??[];let{data:s,error:o}=await r.from("staff_role_permissions").select("permission_key, role_id").in("role_id",c);if(o)throw console.error("Error loading staff permissions",o),new i("Unable to load staff permissions",503);s?.forEach(e=>{p.add(e.permission_key)})}return{id:t.user_id,email:t.email,displayName:t.display_name,passkeyEnrolled:t.passkey_enrolled,roles:d,permissions:Array.from(p),analyticsId:(0,a.Se)(t.email)}});async function u(e){let r=await l();if(!r)throw new i("Staff membership required",403);if(e?.permission&&!r.permissions.includes(e.permission))throw new i(`Missing required permission: ${e.permission}`,403);return r}},1682:(e,r,t)=>{t.d(r,{i_:()=>c,jq:()=>l});var s=t(5665),o=t(6663),a=t(7416);let i=["SUPABASE_URL","SUPABASE_ANON_KEY","SUPABASE_SERVICE_ROLE"];function n(){for(let e of i)if(!process.env[e])throw Error(`Missing required environment variable ${e}`)}function l(){return n(),(0,o.createServerComponentClient)({cookies:a.cookies},{supabaseUrl:process.env.SUPABASE_URL,supabaseKey:process.env.SUPABASE_ANON_KEY})}let u=null;function c(){return n(),u||(u=(0,s.eI)(process.env.SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE,{auth:{autoRefreshToken:!1,persistSession:!1}})),u}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[925,13,680,711],()=>t(8089));module.exports=s})();