(()=>{var e={};e.id=569,e.ids=[569],e.modules={2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},852:e=>{"use strict";e.exports=require("async_hooks")},4300:e=>{"use strict";e.exports=require("buffer")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},4577:e=>{"use strict";e.exports=require("punycode")},2781:e=>{"use strict";e.exports=require("stream")},7310:e=>{"use strict";e.exports=require("url")},9796:e=>{"use strict";e.exports=require("zlib")},7600:(e,s,r)=>{"use strict";r.r(s),r.d(s,{GlobalError:()=>n.a,__next_app__:()=>u,pages:()=>c,routeModule:()=>m,tree:()=>d});var t=r(6661),a=r(4749),i=r(6933),n=r.n(i),o=r(1769),l={};for(let e in o)0>["default","tree","pages","GlobalError","__next_app__","routeModule"].indexOf(e)&&(l[e]=()=>o[e]);r.d(s,l);let d=["",{children:["releases",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(r.bind(r,9054)),"/Users/haydenfarquhar/Projects/torvus-console/apps/console/app/releases/page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(r.bind(r,6086)),"/Users/haydenfarquhar/Projects/torvus-console/apps/console/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(r.t.bind(r,8271,23)),"next/dist/client/components/not-found-error"]}],c=["/Users/haydenfarquhar/Projects/torvus-console/apps/console/app/releases/page.tsx"],u={require:r,loadChunk:()=>Promise.resolve()},m=new t.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/releases/page",pathname:"/releases",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},893:(e,s,r)=>{let t={"77170e63b0d84df4e76bf0b17d0c531ef620089c":()=>Promise.resolve().then(r.bind(r,5195)).then(e=>e.simulateReleaseAction)};async function a(e,...s){return(await t[e]()).apply(null,s)}e.exports={"77170e63b0d84df4e76bf0b17d0c531ef620089c":a.bind(null,"77170e63b0d84df4e76bf0b17d0c531ef620089c")}},3078:(e,s,r)=>{Promise.resolve().then(r.bind(r,1699))},966:(e,s,r)=>{Promise.resolve().then(r.t.bind(r,7868,23))},4113:(e,s,r)=>{Promise.resolve().then(r.t.bind(r,1387,23)),Promise.resolve().then(r.t.bind(r,8739,23)),Promise.resolve().then(r.t.bind(r,3285,23)),Promise.resolve().then(r.t.bind(r,6753,23)),Promise.resolve().then(r.t.bind(r,1722,23)),Promise.resolve().then(r.t.bind(r,320,23))},1699:(e,s,r)=>{"use strict";r.d(s,{SimulationForm:()=>n});var t=r(9593),a=r(480);let i={ok:!1,message:"No simulation run yet."};function n({action:e}){let[s,r,n]=(0,a.useActionState)(e,i);return(0,t.jsxs)("section",{className:"panel","aria-labelledby":"simulate-heading",children:[(0,t.jsxs)("div",{className:"panel__header",children:[t.jsx("h2",{id:"simulate-heading",children:"Simulate release"}),t.jsx("span",{className:"tag subtle",children:"No side effects"})]}),(0,t.jsxs)("form",{action:r,className:"simulate-form",children:[(0,t.jsxs)("label",{children:["Release identifier",t.jsx("input",{name:"releaseId",type:"text",placeholder:"2024.09.18",required:!0,disabled:n})]}),(0,t.jsxs)("label",{children:["Notes",t.jsx("textarea",{name:"notes",placeholder:"Optional context",rows:3,maxLength:240,disabled:n})]}),t.jsx("button",{type:"submit",className:"button primary",disabled:n,children:n?"Simulating…":"Run simulation"})]}),(0,t.jsxs)("div",{className:s.ok?"simulate-result success":"simulate-result",role:"status",children:[t.jsx("h3",{children:"Result"}),t.jsx("p",{children:s.message}),s.correlationId&&(0,t.jsxs)("p",{className:"muted",children:["Correlation ID: ",s.correlationId]})]})]})}},6086:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>p,metadata:()=>u,runtime:()=>m});var t=r(36),a=r(2746),i=r(7416),n=r(1928),o=r(3613),l=r(4463);r(1425),r(5178);var d=r(3199),c=r(9584);let u={title:"Torvus Console",description:"Privileged Torvus staff portal with RBAC, dual-control, and audit evidence.",icons:[{rel:"icon",url:"/favicon.ico"}]},m="nodejs";async function p({children:e}){let s=(0,i.headers)(),r=s.get("x-pathname")??"/",u=s.get("x-csp-nonce")??"",m=s.get("x-correlation-id")??crypto.randomUUID(),p=r.startsWith("/enroll-passkey"),h=await (0,d.Ot)();if(!h)return t.jsx("html",{lang:"en","data-theme":"torvus-staff",children:t.jsx("body",{"data-correlation":m,className:"body-minimal",children:(0,t.jsxs)("main",{className:"unauthorised",children:[t.jsx("h1",{children:"Access denied"}),t.jsx("p",{children:"Torvus Console is restricted to enrolled staff. Contact Security Operations."})]})})});if(h.passkeyEnrolled||p||(0,n.redirect)("/enroll-passkey"),(0,c.C4)().capture("staff_console_viewed",{path:r,env:"production",user:h.analyticsId,correlation_id:m}),p)return t.jsx("html",{lang:"en","data-theme":"torvus-staff",children:t.jsx("body",{"data-correlation":m,className:"body-minimal",children:t.jsx(o.Suspense,{fallback:t.jsx("div",{className:"loading","data-testid":"loading"}),children:e})})});let f=(0,c.mL)(h.permissions);return t.jsx("html",{lang:"en","data-theme":"torvus-staff",children:(0,t.jsxs)("body",{"data-correlation":m,className:"layout-shell",children:[(0,t.jsxs)("aside",{className:"sidebar","aria-label":"Primary",children:[(0,t.jsxs)("div",{className:"sidebar__brand",children:[t.jsx("span",{className:"brand-mark","aria-hidden":!0,children:"⚡"}),t.jsx("span",{className:"brand-text",children:"Torvus Console"})]}),t.jsx("nav",{children:t.jsx("ul",{children:f.map(e=>t.jsx("li",{children:t.jsx(a.default,{href:e.href,className:(0,l.Z)("nav-link",{active:r===e.href||"/"!==e.href&&r.startsWith(e.href)}),children:e.label})},e.href))})}),(0,t.jsxs)("footer",{children:[t.jsx("span",{className:"staff-name",children:h.displayName}),t.jsx("span",{className:"staff-email",children:h.email})]})]}),(0,t.jsxs)("div",{className:"content",children:[(0,t.jsxs)("header",{className:"topbar",children:[t.jsx("div",{className:"breadcrumbs",children:"/"===r?"Overview":r.replace("/","").replace("-"," ")}),t.jsx("div",{className:"topbar__meta","data-nonce":u,children:t.jsx("span",{className:"tag",children:h.roles.join(", ")||"staff"})})]}),t.jsx("main",{className:"main","data-testid":"main-content",children:t.jsx(o.Suspense,{fallback:t.jsx("div",{className:"loading","data-testid":"loading"}),children:e})})]})]})})}},5195:(e,s,r)=>{"use strict";r.r(s),r.d(s,{simulateReleaseAction:()=>c});var t=r(482);r(7929);var a=r(3680),i=r(3199),n=r(9584),o=r(2477);let l=a.Ry({releaseId:a.Z_().min(3).max(64),notes:a.Z_().max(240).optional()});async function d(e,s){let r=process.env.TORVUS_RELEASE_SIMULATOR_URL;if(!r)return{ok:!0,message:"Simulator endpoint not configured; returning dry-run success.",correlationId:s};try{let t=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","X-Correlation-Id":s},body:JSON.stringify(e)});if(!t.ok){let e=await t.text();return{ok:!1,message:`Simulator error (${t.status}): ${e}`,correlationId:s}}let a=await t.json();return{ok:!0,message:a.message??"Simulation completed successfully.",correlationId:s}}catch(e){return{ok:!1,message:`Simulation request failed: ${e.message??e}`,correlationId:s}}}async function c(e,s){let r=await (0,i.vT)({permission:"releases.simulate"}),t=l.safeParse(Object.fromEntries(s.entries())),a=crypto.randomUUID();if(!t.success)return{ok:!1,message:"Invalid simulation input. Confirm release identifier and try again.",correlationId:a};let o=t.data,c=await d(o,a);return(0,n.C4)().capture("release_simulated",{user:r.analyticsId,release_id:o.releaseId,ok:c.ok,correlation_id:a,env:"production"}),c}(0,o.h)([c]),(0,t.j)("77170e63b0d84df4e76bf0b17d0c531ef620089c",c)},9054:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>u});var t=r(36),a=r(7416),i=r(3199),n=r(1682),o=r(9584);let l=(0,r(89).createProxy)(String.raw`/Users/haydenfarquhar/Projects/torvus-console/apps/console/app/releases/simulation-form.tsx#SimulationForm`);var d=r(5195);async function c(){let e=(0,n.i_)(),{data:s,error:r}=await e.from("release_decisions").select("id, version, decided_at, decided_by, status, notes").order("decided_at",{ascending:!1}).limit(20);return r?(console.error("Failed to load release decisions",r),[]):s??[]}async function u(){let e=await (0,i.vT)({permission:"releases.simulate"}),s=(0,a.headers)().get("x-correlation-id")??crypto.randomUUID(),r=await c();return(0,o.C4)().capture("staff_console_viewed",{path:"/releases",correlation_id:s,user:e.analyticsId,env:"production"}),(0,t.jsxs)("div",{className:"page",children:[(0,t.jsxs)("section",{className:"panel","aria-labelledby":"releases-heading",children:[(0,t.jsxs)("div",{className:"panel__header",children:[t.jsx("h1",{id:"releases-heading",children:"Recent release decisions"}),t.jsx("span",{className:"tag subtle",children:"Read only"})]}),t.jsx("div",{className:"table-wrapper",children:(0,t.jsxs)("table",{children:[t.jsx("thead",{children:(0,t.jsxs)("tr",{children:[t.jsx("th",{scope:"col",children:"Version"}),t.jsx("th",{scope:"col",children:"Status"}),t.jsx("th",{scope:"col",children:"Decided at"}),t.jsx("th",{scope:"col",children:"Decided by"}),t.jsx("th",{scope:"col",children:"Notes"})]})}),(0,t.jsxs)("tbody",{children:[0===r.length&&t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:"empty",children:"No release decisions recorded yet."})}),r.map(e=>(0,t.jsxs)("tr",{children:[t.jsx("td",{children:e.version}),t.jsx("td",{children:e.status}),t.jsx("td",{children:new Date(e.decided_at).toISOString()}),t.jsx("td",{children:e.decided_by}),t.jsx("td",{children:e.notes??"—"})]},e.id))]})]})})]}),t.jsx(l,{action:d.simulateReleaseAction})]})}},9584:(e,s,r)=>{"use strict";r.d(s,{Se:()=>l,mL:()=>d,C4:()=>o});let t=require("node:crypto"),a=[{href:"/overview",label:"Overview",permission:"metrics.view"},{href:"/audit-events",label:"Audit Events",permission:"audit.read"},{href:"/releases",label:"Releases",permission:"releases.simulate"}];class i{capture(e,s={}){let r={event:e,properties:{$lib:"torvus-console",env:"production",...s},uuid:(0,t.randomUUID)()};this.queue.push({event:e,payload:r.properties}),this.host&&this.key&&fetch(`${this.host}/capture/`,{method:"POST",headers:{Authorization:`Bearer ${this.key}`,"Content-Type":"application/json"},body:JSON.stringify(r)}).catch(e=>{console.warn("Analytics capture failed",e)})}getQueue(){return[...this.queue]}constructor(){this.queue=[],this.host=process.env.NEXT_PUBLIC_POSTHOG_HOST,this.key=process.env.NEXT_PUBLIC_POSTHOG_KEY}}let n=null;function o(){return n||(n=new i),n}function l(e){let s=(0,t.createHash)("sha256");return s.update(e.trim().toLowerCase()),s.digest("hex")}function d(e){return a.filter(s=>!s.permission||e.includes(s.permission)).map(({href:e,label:s})=>({href:e,label:s}))}},3199:(e,s,r)=>{"use strict";r.d(s,{Ot:()=>l,vT:()=>d});var t=r(3613),a=r(1682),i=r(9584);class n extends Error{constructor(e,s=403){super(e),this.status=s,this.name="StaffAccessError"}}let o=(0,t.cache)(async()=>{let e=(0,a.jq)(),{data:s,error:r}=await e.auth.getUser();return r?(console.error("Failed to resolve session user",r),null):s.user?{id:s.user.id,email:s.user.email??"unknown@torvussecurity.com"}:null}),l=(0,t.cache)(async()=>{let e=await o();if(!e)return null;let s=(0,a.i_)(),{data:r,error:t}=await s.from("staff_users").select("user_id, email, display_name, passkey_enrolled").eq("user_id",e.id).maybeSingle();if(t)throw console.error("Error loading staff user",t),new n("Unable to load staff profile",503);if(!r)return null;let{data:l,error:d}=await s.from("staff_role_members").select("role_id").eq("user_id",e.id);if(d)throw console.error("Error loading staff roles",d),new n("Unable to load staff roles",503);let c=l?.map(e=>e.role_id)??[],u=[],m=new Set;if(c.length){let{data:e,error:r}=await s.from("staff_roles").select("id, name").in("id",c);if(r)throw console.error("Error loading staff role names",r),new n("Unable to resolve role names",503);u=e?.map(e=>e.name)??[];let{data:t,error:a}=await s.from("staff_role_permissions").select("permission_key, role_id").in("role_id",c);if(a)throw console.error("Error loading staff permissions",a),new n("Unable to load staff permissions",503);t?.forEach(e=>{m.add(e.permission_key)})}return{id:r.user_id,email:r.email,displayName:r.display_name,passkeyEnrolled:r.passkey_enrolled,roles:u,permissions:Array.from(m),analyticsId:(0,i.Se)(r.email)}});async function d(e){let s=await l();if(!s)throw new n("Staff membership required",403);if(e?.permission&&!s.permissions.includes(e.permission))throw new n(`Missing required permission: ${e.permission}`,403);return s}},1682:(e,s,r)=>{"use strict";r.d(s,{i_:()=>c,jq:()=>l});var t=r(5665),a=r(6663),i=r(7416);let n=["SUPABASE_URL","SUPABASE_ANON_KEY","SUPABASE_SERVICE_ROLE"];function o(){for(let e of n)if(!process.env[e])throw Error(`Missing required environment variable ${e}`)}function l(){return o(),(0,a.createServerComponentClient)({cookies:i.cookies},{supabaseUrl:process.env.SUPABASE_URL,supabaseKey:process.env.SUPABASE_ANON_KEY})}let d=null;function c(){return o(),d||(d=(0,t.eI)(process.env.SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE,{auth:{autoRefreshToken:!1,persistSession:!1}})),d}},5178:()=>{},1425:()=>{}};var s=require("../../webpack-runtime.js");s.C(e);var r=e=>s(s.s=e),t=s.X(0,[925,13,870,680,497],()=>r(7600));module.exports=t})();