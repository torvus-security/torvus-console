(()=>{var e={};e.id=320,e.ids=[320],e.modules={2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},852:e=>{"use strict";e.exports=require("async_hooks")},4300:e=>{"use strict";e.exports=require("buffer")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},4577:e=>{"use strict";e.exports=require("punycode")},2781:e=>{"use strict";e.exports=require("stream")},7310:e=>{"use strict";e.exports=require("url")},9796:e=>{"use strict";e.exports=require("zlib")},71:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>i.a,__next_app__:()=>u,pages:()=>c,routeModule:()=>p,tree:()=>d});var r=s(6661),a=s(4749),n=s(6933),i=s.n(n),o=s(1769),l={};for(let e in o)0>["default","tree","pages","GlobalError","__next_app__","routeModule"].indexOf(e)&&(l[e]=()=>o[e]);s.d(t,l);let d=["",{children:["audit-events",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,2153)),"/Users/haydenfarquhar/Projects/torvus-console/apps/console/app/audit-events/page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(s.bind(s,6086)),"/Users/haydenfarquhar/Projects/torvus-console/apps/console/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,8271,23)),"next/dist/client/components/not-found-error"]}],c=["/Users/haydenfarquhar/Projects/torvus-console/apps/console/app/audit-events/page.tsx"],u={require:s,loadChunk:()=>Promise.resolve()},p=new r.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/audit-events/page",pathname:"/audit-events",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},2986:(e,t,s)=>{let r={bf3bf070161915f4dbaef4395697484297373758:()=>Promise.resolve().then(s.bind(s,3667)).then(e=>e.exportAuditJson),d36d5d5f67f5ff030155eaf8022e9f242257ae2b:()=>Promise.resolve().then(s.bind(s,3667)).then(e=>e.exportAuditCsv)};async function a(e,...t){return(await r[e]()).apply(null,t)}e.exports={bf3bf070161915f4dbaef4395697484297373758:a.bind(null,"bf3bf070161915f4dbaef4395697484297373758"),d36d5d5f67f5ff030155eaf8022e9f242257ae2b:a.bind(null,"d36d5d5f67f5ff030155eaf8022e9f242257ae2b")}},966:(e,t,s)=>{Promise.resolve().then(s.t.bind(s,7868,23))},4113:(e,t,s)=>{Promise.resolve().then(s.t.bind(s,1387,23)),Promise.resolve().then(s.t.bind(s,8739,23)),Promise.resolve().then(s.t.bind(s,3285,23)),Promise.resolve().then(s.t.bind(s,6753,23)),Promise.resolve().then(s.t.bind(s,1722,23)),Promise.resolve().then(s.t.bind(s,320,23))},6723:()=>{},3667:(e,t,s)=>{"use strict";s.r(t),s.d(t,{exportAuditCsv:()=>u,exportAuditJson:()=>p});var r=s(482);s(7929);var a=s(3199),n=s(1682),i=s(9584),o=s(1967);async function l(e){let t=(0,n.i_)().from("audit_events").select("id, actor, event, created_at, object, metadata").order("created_at",{ascending:!1}).limit(1e3);e.actor&&(t=t.ilike("actor",`%${e.actor}%`)),e.event&&(t=t.ilike("event",`%${e.event}%`)),e.from&&(t=t.gte("created_at",e.from)),e.to&&(t=t.lte("created_at",e.to));let{data:s,error:r}=await t;if(r)throw console.error("Failed to export audit events",r),Error("Unable to export audit events");return s??[]}function d(e,t){let s=new Date().toISOString().replace(/[:.]/g,"-");return`${e}-${s}.${t}`}async function c(e,t,s){(0,i.C4)().capture("audit_events_exported",{format:s,count:e.length,user:t,env:"production"})}async function u(e){let t=await (0,a.vT)({permission:"audit.export"}),s=o.e.safeParse(Object.fromEntries(e.entries())),r=s.success?s.data:{page:1},n=await l(r);return await c(n,t.analyticsId,"csv"),new Response(["id,actor,event,created_at,object,metadata",...n.map(e=>{let t=e.metadata?JSON.stringify(e.metadata).replace(/"/g,'""'):"",s=e.object?e.object.replace(/"/g,'""'):"";return[e.id,e.actor,e.event,e.created_at,s,t].map(e=>`"${e}"`).join(",")})].join("\n"),{headers:{"Content-Type":"text/csv","Content-Disposition":`attachment; filename="${d("audit-events","csv")}"`}})}async function p(e){let t=await (0,a.vT)({permission:"audit.export"}),s=o.e.safeParse(Object.fromEntries(e.entries())),r=s.success?s.data:{page:1},n=await l(r);return await c(n,t.analyticsId,"json"),new Response(JSON.stringify(n,null,2),{headers:{"Content-Type":"application/json","Content-Disposition":`attachment; filename="${d("audit-events","json")}"`}})}(0,s(2477).h)([u,p]),(0,r.j)("d36d5d5f67f5ff030155eaf8022e9f242257ae2b",u),(0,r.j)("bf3bf070161915f4dbaef4395697484297373758",p)},2153:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>h});var r=s(36),a=s(7416),n=s(3199),i=s(1682),o=s(9584),l=s(3667),d=s(1967);let c=l.exportAuditCsv,u=l.exportAuditJson;async function p(e){let t=(0,i.i_)().from("audit_events").select("id, actor, event, created_at, object, metadata",{count:"exact"}).order("created_at",{ascending:!1});e.actor&&(t=t.ilike("actor",`%${e.actor}%`)),e.event&&(t=t.ilike("event",`%${e.event}%`)),e.from&&(t=t.gte("created_at",e.from)),e.to&&(t=t.lte("created_at",e.to));let s=(e.page-1)*50,{data:r,count:a,error:n}=await t.range(s,s+50-1);if(n)throw console.error("Failed to load audit events",n),Error("Unable to load audit events");return{events:r??[],total:a??0,page:e.page,pageSize:50}}let m=["actor","event","from","to"];function f(e){let t=[];for(let s of m){let r=e[s];"string"==typeof r&&r&&t.push([s,r])}return t}async function h({searchParams:e}){let t=await (0,n.vT)({permission:"audit.read"}),s=(0,a.headers)().get("x-correlation-id")??crypto.randomUUID(),i=d.e.parse({actor:"string"==typeof e?.actor?e?.actor:void 0,event:"string"==typeof e?.event?e?.event:void 0,from:"string"==typeof e?.from?e?.from:void 0,to:"string"==typeof e?.to?e?.to:void 0,page:"string"==typeof e?.page?e?.page:void 0});(0,o.C4)().capture("staff_console_viewed",{path:"/audit-events",correlation_id:s,env:"production",user:t.analyticsId});let{events:l,total:h,page:v,pageSize:x}=await p(i),b=Math.max(1,Math.ceil(h/x)),j=new URLSearchParams;for(let e of m){let t=i[e];t&&j.set(e,t)}return r.jsx("div",{className:"page",children:(0,r.jsxs)("section",{className:"panel","aria-labelledby":"audit-heading",children:[(0,r.jsxs)("div",{className:"panel__header",children:[r.jsx("h1",{id:"audit-heading",children:"Audit events"}),r.jsx("span",{className:"tag subtle",children:"Evidence ready"})]}),(0,r.jsxs)("form",{method:"get",className:"filters","data-testid":"audit-filter-form",children:[(0,r.jsxs)("label",{children:["Actor",r.jsx("input",{type:"text",name:"actor",defaultValue:i.actor??"",placeholder:"alice@torvussecurity.com"})]}),(0,r.jsxs)("label",{children:["Event key",r.jsx("input",{type:"text",name:"event",defaultValue:i.event??"",placeholder:"releases.execute"})]}),(0,r.jsxs)("label",{children:["From",r.jsx("input",{type:"datetime-local",name:"from",defaultValue:i.from??""})]}),(0,r.jsxs)("label",{children:["To",r.jsx("input",{type:"datetime-local",name:"to",defaultValue:i.to??""})]}),r.jsx("button",{type:"submit",className:"button primary",children:"Apply"})]}),r.jsx("div",{className:"table-wrapper",children:(0,r.jsxs)("table",{children:[r.jsx("thead",{children:(0,r.jsxs)("tr",{children:[r.jsx("th",{scope:"col",children:"Timestamp"}),r.jsx("th",{scope:"col",children:"Actor"}),r.jsx("th",{scope:"col",children:"Event"}),r.jsx("th",{scope:"col",children:"Object"}),r.jsx("th",{scope:"col",children:"Metadata"})]})}),(0,r.jsxs)("tbody",{children:[0===l.length&&r.jsx("tr",{children:r.jsx("td",{colSpan:5,className:"empty",children:"No audit events match your filters."})}),l.map(e=>(0,r.jsxs)("tr",{children:[r.jsx("td",{children:new Date(e.created_at).toISOString()}),r.jsx("td",{children:e.actor}),r.jsx("td",{children:e.event}),r.jsx("td",{children:e.object??"—"}),r.jsx("td",{children:r.jsx("pre",{className:"metadata",children:JSON.stringify(e.metadata??{},null,2)})})]},e.id))]})]})}),(0,r.jsxs)("div",{className:"table-footer",children:[(0,r.jsxs)("span",{children:["Page ",v," of ",b," (",h," events)"]}),(0,r.jsxs)("div",{className:"pagination",children:[r.jsx("a",{className:"button ghost","aria-disabled":v<=1,href:`?${new URLSearchParams({...Object.fromEntries(j.entries()),page:String(Math.max(1,v-1))})}`,children:"Previous"}),r.jsx("a",{className:"button ghost","aria-disabled":v>=b,href:`?${new URLSearchParams({...Object.fromEntries(j.entries()),page:String(Math.min(b,v+1))})}`,children:"Next"})]})]}),(0,r.jsxs)("div",{className:"export-buttons",children:[(0,r.jsxs)("form",{action:c,children:[f(i).map(([e,t])=>r.jsx("input",{type:"hidden",name:e,value:t},`csv-${e}`)),r.jsx("button",{type:"submit",className:"button secondary",children:"Export CSV"})]}),(0,r.jsxs)("form",{action:u,children:[f(i).map(([e,t])=>r.jsx("input",{type:"hidden",name:e,value:t},`json-${e}`)),r.jsx("button",{type:"submit",className:"button secondary",children:"Export JSON"})]})]})]})})}},1967:(e,t,s)=>{"use strict";s.d(t,{e:()=>a});var r=s(3680);let a=r.Ry({actor:r.Z_().trim().min(1).max(128).optional(),event:r.Z_().trim().min(1).max(128).optional(),from:r.Z_().trim().optional(),to:r.Z_().trim().optional(),page:r.oQ.number().int().positive().default(1)})},6086:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>m,metadata:()=>u,runtime:()=>p});var r=s(36),a=s(2746),n=s(7416),i=s(1928),o=s(3613),l=s(4463);s(1425),s(5178);var d=s(3199),c=s(9584);let u={title:"Torvus Console",description:"Privileged Torvus staff portal with RBAC, dual-control, and audit evidence.",icons:[{rel:"icon",url:"/favicon.ico"}]},p="nodejs";async function m({children:e}){let t=(0,n.headers)(),s=t.get("x-pathname")??"/",u=t.get("x-csp-nonce")??"",p=t.get("x-correlation-id")??crypto.randomUUID(),m=s.startsWith("/enroll-passkey"),f=await (0,d.Ot)();if(!f)return r.jsx("html",{lang:"en","data-theme":"torvus-staff",children:r.jsx("body",{"data-correlation":p,className:"body-minimal",children:(0,r.jsxs)("main",{className:"unauthorised",children:[r.jsx("h1",{children:"Access denied"}),r.jsx("p",{children:"Torvus Console is restricted to enrolled staff. Contact Security Operations."})]})})});if(f.passkeyEnrolled||m||(0,i.redirect)("/enroll-passkey"),(0,c.C4)().capture("staff_console_viewed",{path:s,env:"production",user:f.analyticsId,correlation_id:p}),m)return r.jsx("html",{lang:"en","data-theme":"torvus-staff",children:r.jsx("body",{"data-correlation":p,className:"body-minimal",children:r.jsx(o.Suspense,{fallback:r.jsx("div",{className:"loading","data-testid":"loading"}),children:e})})});let h=(0,c.mL)(f.permissions);return r.jsx("html",{lang:"en","data-theme":"torvus-staff",children:(0,r.jsxs)("body",{"data-correlation":p,className:"layout-shell",children:[(0,r.jsxs)("aside",{className:"sidebar","aria-label":"Primary",children:[(0,r.jsxs)("div",{className:"sidebar__brand",children:[r.jsx("span",{className:"brand-mark","aria-hidden":!0,children:"⚡"}),r.jsx("span",{className:"brand-text",children:"Torvus Console"})]}),r.jsx("nav",{children:r.jsx("ul",{children:h.map(e=>r.jsx("li",{children:r.jsx(a.default,{href:e.href,className:(0,l.Z)("nav-link",{active:s===e.href||"/"!==e.href&&s.startsWith(e.href)}),children:e.label})},e.href))})}),(0,r.jsxs)("footer",{children:[r.jsx("span",{className:"staff-name",children:f.displayName}),r.jsx("span",{className:"staff-email",children:f.email})]})]}),(0,r.jsxs)("div",{className:"content",children:[(0,r.jsxs)("header",{className:"topbar",children:[r.jsx("div",{className:"breadcrumbs",children:"/"===s?"Overview":s.replace("/","").replace("-"," ")}),r.jsx("div",{className:"topbar__meta","data-nonce":u,children:r.jsx("span",{className:"tag",children:f.roles.join(", ")||"staff"})})]}),r.jsx("main",{className:"main","data-testid":"main-content",children:r.jsx(o.Suspense,{fallback:r.jsx("div",{className:"loading","data-testid":"loading"}),children:e})})]})]})})}},9584:(e,t,s)=>{"use strict";s.d(t,{Se:()=>l,mL:()=>d,C4:()=>o});let r=require("node:crypto"),a=[{href:"/overview",label:"Overview",permission:"metrics.view"},{href:"/audit-events",label:"Audit Events",permission:"audit.read"},{href:"/releases",label:"Releases",permission:"releases.simulate"}];class n{capture(e,t={}){let s={event:e,properties:{$lib:"torvus-console",env:"production",...t},uuid:(0,r.randomUUID)()};this.queue.push({event:e,payload:s.properties}),this.host&&this.key&&fetch(`${this.host}/capture/`,{method:"POST",headers:{Authorization:`Bearer ${this.key}`,"Content-Type":"application/json"},body:JSON.stringify(s)}).catch(e=>{console.warn("Analytics capture failed",e)})}getQueue(){return[...this.queue]}constructor(){this.queue=[],this.host=process.env.NEXT_PUBLIC_POSTHOG_HOST,this.key=process.env.NEXT_PUBLIC_POSTHOG_KEY}}let i=null;function o(){return i||(i=new n),i}function l(e){let t=(0,r.createHash)("sha256");return t.update(e.trim().toLowerCase()),t.digest("hex")}function d(e){return a.filter(t=>!t.permission||e.includes(t.permission)).map(({href:e,label:t})=>({href:e,label:t}))}},3199:(e,t,s)=>{"use strict";s.d(t,{Ot:()=>l,vT:()=>d});var r=s(3613),a=s(1682),n=s(9584);class i extends Error{constructor(e,t=403){super(e),this.status=t,this.name="StaffAccessError"}}let o=(0,r.cache)(async()=>{let e=(0,a.jq)(),{data:t,error:s}=await e.auth.getUser();return s?(console.error("Failed to resolve session user",s),null):t.user?{id:t.user.id,email:t.user.email??"unknown@torvussecurity.com"}:null}),l=(0,r.cache)(async()=>{let e=await o();if(!e)return null;let t=(0,a.i_)(),{data:s,error:r}=await t.from("staff_users").select("user_id, email, display_name, passkey_enrolled").eq("user_id",e.id).maybeSingle();if(r)throw console.error("Error loading staff user",r),new i("Unable to load staff profile",503);if(!s)return null;let{data:l,error:d}=await t.from("staff_role_members").select("role_id").eq("user_id",e.id);if(d)throw console.error("Error loading staff roles",d),new i("Unable to load staff roles",503);let c=l?.map(e=>e.role_id)??[],u=[],p=new Set;if(c.length){let{data:e,error:s}=await t.from("staff_roles").select("id, name").in("id",c);if(s)throw console.error("Error loading staff role names",s),new i("Unable to resolve role names",503);u=e?.map(e=>e.name)??[];let{data:r,error:a}=await t.from("staff_role_permissions").select("permission_key, role_id").in("role_id",c);if(a)throw console.error("Error loading staff permissions",a),new i("Unable to load staff permissions",503);r?.forEach(e=>{p.add(e.permission_key)})}return{id:s.user_id,email:s.email,displayName:s.display_name,passkeyEnrolled:s.passkey_enrolled,roles:u,permissions:Array.from(p),analyticsId:(0,n.Se)(s.email)}});async function d(e){let t=await l();if(!t)throw new i("Staff membership required",403);if(e?.permission&&!t.permissions.includes(e.permission))throw new i(`Missing required permission: ${e.permission}`,403);return t}},1682:(e,t,s)=>{"use strict";s.d(t,{i_:()=>c,jq:()=>l});var r=s(5665),a=s(6663),n=s(7416);let i=["SUPABASE_URL","SUPABASE_ANON_KEY","SUPABASE_SERVICE_ROLE"];function o(){for(let e of i)if(!process.env[e])throw Error(`Missing required environment variable ${e}`)}function l(){return o(),(0,a.createServerComponentClient)({cookies:n.cookies},{supabaseUrl:process.env.SUPABASE_URL,supabaseKey:process.env.SUPABASE_ANON_KEY})}let d=null;function c(){return o(),d||(d=(0,r.eI)(process.env.SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE,{auth:{autoRefreshToken:!1,persistSession:!1}})),d}},5178:()=>{},1425:()=>{}};var t=require("../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[925,13,870,680,497],()=>s(71));module.exports=r})();